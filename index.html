<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>土星星环回忆</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            cursor: crosshair;
            /* 移动端优化 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #000 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 2s ease-out;
        }

        #loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            color: #fff;
            font-size: 24px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .anniversary-fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #photo-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #fff;
            border-radius: 20px;
            padding: 0;
            z-index: 100;
            transition: transform 0.35s ease-out;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #photo-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #photo-modal img {
            max-width: calc(90vw - 50px);
            max-height: calc(90vh - 50px);
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
        }


        .modal-title {
            color: #fff;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
        }


        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #fff;
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            font-size: 14px;
            z-index: 50;
            min-width: 220px;
            max-height: 80vh;
            display: block; /* 确保控制面板默认显示 */
        }

        .control-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-panel h3 {
            margin: 0;
            font-size: 16px;
            color: #ffd700;
        }

        .toggle-details-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .toggle-details-btn:hover {
            background: rgba(255, 215, 0, 0.4);
            transform: scale(1.1);
        }

        .detailed-controls {
            transition: all 0.3s ease;
            overflow-y: auto;
            max-height: calc(80vh - 80px); /* 减去标题区域的高度 */
            opacity: 1;
            scrollbar-width: thin;
            scrollbar-color: #ffd700 #333;
        }

        .detailed-controls.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group .value {
            font-size: 12px;
            color: #ffd700;
            text-align: center;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        @media (max-width: 768px) {
            .loading-text {
                font-size: 18px;
            }
            
            #photo-modal {
                width: 90vw;
                height: 80vh;
                max-width: 90vw;
                max-height: 80vh;
                padding: 15px;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            
            .control-panel {
                top: 10px;
                right: 10px;
                padding: 10px;
                min-width: 180px;
                font-size: 12px;
                max-height: 80vh;
            }
            
            .control-panel h3 {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-text">
            <div id="love-counter">恋爱第 <span id="day-count">1</span> 天</div>
            <div id="anniversary-message" style="display: none; font-size: 20px; margin-top: 10px; color: #ffd700;"> 一周年已达成，解锁新场景</div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div id="photo-modal">
        <div class="modal-title" id="modal-title"></div>
        <img id="modal-image" src="" alt="回忆照片">
    </div>

    <div class="control-panel">
        <div class="control-panel-header">
            <h3>🌟 控制面板</h3>
            <button id="toggleDetails" class="toggle-details-btn">+</button>
        </div>
        <div id="detailed-controls" class="detailed-controls">
        <div class="control-group">
            <label>旋转速度 (圈/分钟)</label>
            <input type="range" id="rotationSpeed" min="0" max="2" step="0.1" value="0">
            <div class="value" id="rotationValue">0 圈/分钟</div>
        </div>
        <div class="control-group">
            <label>相机距离</label>
            <input type="range" id="cameraDistance" min="8" max="30" step="0.5" value="13.5">
            <div class="value" id="cameraDistanceValue">13.5</div>
        </div>
        <div class="control-group">
            <label>相机高度</label>
            <input type="range" id="cameraHeight" min="0" max="25" step="0.5" value="5">
            <div class="value" id="cameraHeightValue">5</div>
        </div>
        <div class="control-group">
            <label>相机FOV</label>
            <input type="range" id="cameraFOV" min="10" max="60" step="1" value="49">
            <div class="value" id="cameraFOVValue">49°</div>
        </div>
        <div class="control-group">
            <label>星球屏幕位置 X</label>
            <input type="range" id="planetScreenX" min="0" max="1" step="0.01" value="0.93">
            <div class="value" id="planetScreenXValue">0.93</div>
        </div>
        <div class="control-group">
            <label>星球屏幕位置 Y</label>
            <input type="range" id="planetScreenY" min="0" max="1" step="0.01" value="0.39">
            <div class="value" id="planetScreenYValue">0.39</div>
        </div>
        <div class="control-group">
            <label>星星碎片数量</label>
            <input type="range" id="starFragmentCount" min="50" max="500" step="10" value="200">
            <div class="value" id="starFragmentCountValue">200</div>
        </div>
        <div class="control-group">
            <label>星星碎片大小比例</label>
            <input type="range" id="starFragmentSizeScale" min="1" max="3" step="0.1" value="1">
            <div class="value" id="starFragmentSizeScaleValue">1.0</div>
        </div>
        <div class="control-group">
            <label>内环碎片比例</label>
            <input type="range" id="innerRingRatio" min="0" max="1" step="0.1" value="0.05">
            <div class="value" id="innerRingRatioValue"></div>
        </div>
        <div class="control-group">
            <label>中内环碎片比例</label>
            <input type="range" id="middleRingRatio" min="0" max="1" step="0.1" value="0.3">
            <div class="value" id="middleRingRatioValue"></div>
        </div>
        <div class="control-group">
            <label>中外环碎片比例</label>
            <input type="range" id="outerRingRatio" min="0" max="1" step="0.1" value="0.55">
            <div class="value" id="outerRingRatioValue"></div>
        </div>
        <div class="control-group">
            <label>外环碎片比例</label>
            <input type="range" id="outerMostRingRatio" min="0" max="1" step="0.1" value="0.1">
            <div class="value" id="outerMostRingRatioValue"></div>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="rbStyleToggle" checked style="margin-right: 5px;">
                使用 RenderBundle 风格碎片生成（启用时强制 WebGL 与动态）
            </label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="ringVisibility" checked style="margin-right: 5px;">
                显示星环主体
            </label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="photoThumbnails" style="margin-right: 5px;">
                显示照片缩略图
            </label>
        </div>
        <div class="control-group">
            <label style="color: #4CAF50; font-size: 11px;">
                📱 陀螺仪视差效果已启用<br>
                <span style="color: #888; font-size: 10px;">倾斜设备查看背景移动效果</span>
            </label>
        </div>
        
        <!-- 流星雨效果控制 -->
        <div class="control-group">
            <label style="color: #ff6b6b; font-weight: bold;">☄️ 流星雨效果</label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="meteorShowerToggle" style="margin-right: 5px;">
                启用流星雨背景
            </label>
        </div>
        <div class="control-group">
            <label>流星数量</label>
            <input type="range" id="meteorCount" min="5" max="50" step="5" value="20">
            <div class="value" id="meteorCountValue">20</div>
        </div>
        <div class="control-group">
            <label>生成频率</label>
            <input type="range" id="meteorSpawnRate" min="0.1" max="2" step="0.1" value="0.3">
            <div class="value" id="meteorSpawnRateValue">0.3</div>
        </div>
        <div class="control-group">
            <label>流星速度</label>
            <input type="range" id="meteorSpeed" min="0.1" max="2" step="0.1" value="0.5">
            <div class="value" id="meteorSpeedValue">0.5</div>
        </div>
        <div class="control-group">
            <label>拖尾长度</label>
            <input type="range" id="meteorLength" min="0.1" max="2" step="0.1" value="0.8">
            <div class="value" id="meteorLengthValue">0.8</div>
        </div>
        
        <!-- 后处理效果控制 -->
        <div class="control-group">
            <label style="color: #ff6b6b; font-weight: bold;">🎨 后处理效果</label>
        </div>
        <div class="control-group">
            <label>效果模式</label>
            <select id="postProcessingMode" style="width: 100%; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid #fff; border-radius: 4px; color: #fff;">
                <option value="default">默认模式</option>
                <option value="pixel">像素风格</option>
                <option value="afterimage">拖尾效果</option>
                <option value="toon" selected>Toon风格</option>
            </select>
        </div>
        <div class="control-group" id="pixelControls" style="display: none;">
            <label>像素大小</label>
            <input type="range" id="pixelSize" min="1" max="16" step="1" value="6">
            <div class="value" id="pixelSizeValue">6</div>
        </div>
        <div class="control-group" id="pixelControls2" style="display: none;">
            <label>法线边缘强度</label>
            <input type="range" id="normalEdgeStrength" min="0" max="2" step="0.05" value="1.0">
            <div class="value" id="normalEdgeStrengthValue">1.0</div>
        </div>
        <div class="control-group" id="pixelControls3" style="display: none;">
            <label>深度边缘强度</label>
            <input type="range" id="depthEdgeStrength" min="0" max="1" step="0.05" value="1.0">
            <div class="value" id="depthEdgeStrengthValue"></div>
        </div>
        
        <!-- 拖尾效果控制 -->
        <div class="control-group" id="afterimageControls" style="display: none;">
            <label>拖尾停留时间</label>
            <input type="range" id="afterimageDamp" min="0.7" max="0.99" step="0.01" value="0.98">
            <div class="value" id="afterimageDampValue"></div>
        </div>
        <div class="control-group" id="afterimageControls2" style="display: none;">
            <label>拖尾强度</label>
            <input type="range" id="afterimageStrength" min="0.1" max="1.0" step="0.05" value="1.0">
            <div class="value" id="afterimageStrengthValue"></div>
        </div>
        <div class="control-group" id="afterimageControls3" style="display: none;">
            <label></label>
            <input type="range" id="trailSpeedMultiplier" min="1" max="20" step="1" value="10">
            <div class="value" id="trailSpeedMultiplierValue"></div>
        </div>
        <div class="control-group" id="afterimageControls4" style="display: none;">
            <button id="trailTestToggle" style="width: 100%; padding: 8px; background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b; border-radius: 4px; color: #ff6b6b; cursor: pointer;">
                拖尾测试模式 (加速旋转)
            </button>
        </div>
        
        <!-- Toon风格控制 -->
        <div class="control-group" id="toonControls" style="display: none;">
            <button id="toonModeToggle" style="width: 100%; padding: 8px; background: rgba(255,193,7,0.2); border: 1px solid #ffc107; border-radius: 4px; color: #ffc107; cursor: pointer;">
                Toon风格化渲染
            </button>
        </div>
        <div class="control-group" id="toonControls2" style="display: none;">
            <label>Toon球体数量</label>
            <input type="range" id="toonSphereCount" min="1" max="10" step="1" value="3">
            <div class="value" id="toonSphereCountValue"></div>
        </div>
        <div class="control-group" id="toonControls3" style="display: none;">
            <label>颜色饱和度</label>
            <input type="range" id="toonSaturation" min="0.1" max="1.0" step="0.1" value="0.7">
            <div class="value" id="toonSaturationValue"></div>
        </div>
        <div class="control-group" id="toonControls4" style="display: none;">
            <label>定向光倍率</label>
            <input type="range" id="directionalLightMultiplier" min="1" max="200" step="1" value="3">
            <div class="value" id="directionalLightMultiplierValue"></div>
        </div>
        <div class="control-group" id="toonControls5" style="display: none;">
            <label>半球光倍率</label>
            <input type="range" id="hemisphereLightMultiplier" min="1" max="200" step="1" value="50">
            <div class="value" id="hemisphereLightMultiplierValue"></div>
        </div>
        <div class="control-group" id="toonControls6" style="display: none;">
            <label>环境光倍率</label>
            <input type="range" id="ambientLightMultiplier" min="1" max="200" step="1" value="80">
            <div class="value" id="ambientLightMultiplierValue"></div>
        </div>
        
        <!-- 添加底部边距，确保滚动区域足够 -->
        <div style="height: 200px; margin-bottom: 100px; margin-top: 100px;"></div>
        </div>
    </div>

    <div class="instructions">
        点击/触摸星星碎片查看回忆照片 • 点击/触摸任意地方关闭照片 • 按 'C' 键切换控制面板 • 倾斜设备体验陀螺仪相机旋转效果（最多3°）
    </div>

    <!-- 使用模块版本Three.js，避免重复导入 -->
    <script type="importmap">
        {
            "imports": {
                "three": "./three.js/build/three.module.js",
                "three/addons/": "./three.js/examples/jsm/"
            }
        }
    </script>
    
    <script type="module" src="src/main.js"></script>
</body>
</html>
